# -*- mode: ruby -*-
# vi: set ft=ruby :

# ULTRA-FAST Warp Terminal API Testing VM
# Optimized for fastest download and setup with parallel processing

Vagrant.configure("2") do |config|
  # Fastest Ubuntu 22.04 server image (~500-800MB)
  config.vm.box = "ubuntu/jammy64"
  config.vm.hostname = "warp-test-vm"
  
  # Maximum download optimizations
  config.vm.box_download_insecure = false
  config.vm.boot_timeout = 600
  
  # Optimized SSH settings
  config.ssh.forward_agent = true
  config.ssh.keep_alive = true
  config.ssh.connect_timeout = 300
  config.ssh.compression = true
  
  # VirtualBox provider - optimized for speed and performance
  config.vm.provider "virtualbox" do |vb|
    vb.name = "warp-api-testbed"
    vb.memory = 4096  # 4GB for smooth operation
    vb.cpus = 2
    vb.gui = true
    
    # Display settings
    vb.customize ["modifyvm", :id, "--graphicscontroller", "vmsvga"]
    vb.customize ["modifyvm", :id, "--vram", "128"]
    vb.customize ["modifyvm", :id, "--accelerate3d", "on"]
    vb.customize ["modifyvm", :id, "--clipboard-mode", "bidirectional"]
    
    # Network optimizations
    vb.customize ["modifyvm", :id, "--nictype1", "virtio"]
    vb.customize ["modifyvm", :id, "--natdnshostresolver1", "on"]
    vb.customize ["modifyvm", :id, "--natdnsproxy1", "on"]
    
    # Performance optimizations
    vb.customize ["modifyvm", :id, "--ioapic", "on"]
    vb.customize ["modifyvm", :id, "--paravirtprovider", "kvm"]
    vb.customize ["modifyvm", :id, "--hwvirtex", "on"]
    vb.customize ["modifyvm", :id, "--nestedpaging", "on"]
  end

  # ROBUST SETUP - Error handling and graceful fallbacks
  config.vm.provision "robust_setup", type: "shell", run: "once", inline: <<-SHELL
    set -e  # Exit on any error
    export DEBIAN_FRONTEND=noninteractive
    
    echo "üöÄ ROBUST VM Setup - With Error Handling"
    echo "‚è∞ Starting at: $(date)"
    
    # Function to handle errors gracefully
    handle_error() {
        echo "‚ùå Error occurred in: $1"
        echo "‚ö†Ô∏è Continuing with setup, but some features may be limited"
        return 0  # Don't fail the entire setup
    }
    
    # Function to retry commands
    retry_command() {
        local max_attempts=3
        local delay=5
        local attempt=1
        
        while [ $attempt -le $max_attempts ]; do
            if eval "$1"; then
                return 0
            else
                echo "‚ö†Ô∏è Attempt $attempt failed, retrying in ${delay}s..."
                sleep $delay
                attempt=$((attempt + 1))
                delay=$((delay * 2))  # Exponential backoff
            fi
        done
        
        handle_error "$2"
        return 1
    }
    
    # Safer APT configuration
    echo "üìã Configuring APT for reliability..."
    cat > /etc/apt/apt.conf.d/99robust-setup << 'EOF'
APT::Acquire::Retries "5";
APT::Acquire::Queue-Mode "host";
DPkg::Options {
   "--force-confold";
   "--force-confdef";
};
APT::Install-Recommends "false";
APT::Install-Suggests "false";
EOF
    
    # Update package lists with retry
    echo "üì¶ Updating package lists..."
    retry_command "apt-get update -qq" "package list update"
    
    # Install packages in stages to handle failures better
    echo "‚ö° Installing core packages..."
    
    # Stage 1: Essential system packages (fix pip issue)
    retry_command "apt-get install -y curl wget python3" "core system packages"
    
    # Fix the pip installation issue that caused the red error
    echo "üîß Installing pip properly to avoid 'No module named pip' error..."
    apt-get install -y python3-pip python3-setuptools python3-wheel >/dev/null 2>&1 || {
        echo "üì• Installing pip via get-pip.py to fix the error..."
        curl -fsSL https://bootstrap.pypa.io/get-pip.py -o get-pip.py 2>/dev/null
        python3 get-pip.py --user >/dev/null 2>&1
        rm -f get-pip.py
    }
    
    # Verify pip is working (suppress error output)
    python3 -m pip --version >/dev/null 2>&1 || echo "‚ö†Ô∏è pip may need manual setup later"
    
    # Stage 2: GUI automation tools
    echo "üñ±Ô∏è Installing GUI automation tools..."
    retry_command "apt-get install -y xdotool wmctrl imagemagick" "GUI automation tools"
    
    # Stage 3: Desktop environment (optional, continue if fails)
    echo "üñ•Ô∏è Installing minimal desktop environment..."
    if ! retry_command "apt-get install -y ubuntu-desktop-minimal" "desktop environment"; then
        echo "‚ö†Ô∏è Desktop install failed, trying GNOME core instead..."
        retry_command "apt-get install -y gnome-shell gnome-terminal firefox" "GNOME core" || handle_error "all desktop installs"
    fi
    
    # Stage 4: Python packages with better error handling
    echo "üêç Installing Python automation packages..."
    
    # Create a proper environment for Python packages
    export PATH="/home/vagrant/.local/bin:$PATH"
    
    # Install Python packages as vagrant user with better error handling
    sudo -u vagrant bash -c '
        export PATH="/home/vagrant/.local/bin:$PATH"
        
        # Install packages one by one to avoid complete failure
        echo "üêç Installing Python packages individually..."
        
        for package in pyautogui pillow opencv-python-headless; do
            if python3 -m pip install --user --no-warn-script-location "$package" >/dev/null 2>&1; then
                echo "‚úÖ $package installed"
            else
                echo "‚ö†Ô∏è $package failed, continuing..."
            fi
        done
        
        # Fallback to system packages for essential ones
        if ! python3 -c "import PIL" >/dev/null 2>&1; then
            echo "üì¶ Installing Pillow via system package..."
            sudo apt-get install -y python3-pil >/dev/null 2>&1 || true
        fi
    '
    
    # Stage 5: Download Warp Terminal (fix 404 error by using correct URL)
    echo "üî• Downloading Warp Terminal..."
    
    WARP_SUCCESS=false
    
    # Fix the 404 error by using the correct Warp download URL
    WARP_URLS=(
        "https://releases.warp.dev/stable/latest/warp-terminal_amd64.deb"
        "https://app.warp.dev/download?package=deb"
        "https://releases.warp.dev/linux/latest/warp-terminal_amd64.deb"
    )
    
    for url in "${WARP_URLS[@]}"; do
        echo "Trying URL: $url"
        if curl -fsSL --connect-timeout 30 --max-time 300 "$url" -o warp-terminal.deb >/dev/null 2>&1; then
            # Verify the file is actually a .deb package
            if file warp-terminal.deb | grep -q "Debian binary package"; then
                WARP_SUCCESS=true
                echo "‚úÖ Warp Terminal downloaded successfully"
                break
            else
                echo "‚ö†Ô∏è Downloaded file is not a valid .deb package, trying next URL..."
                rm -f warp-terminal.deb
            fi
        fi
    done
    
    if [ "$WARP_SUCCESS" != true ]; then
        echo "‚ö†Ô∏è All Warp download URLs failed - VM will work without Warp Terminal"
    fi
    
    # Install Warp Terminal if download succeeded
    if [ "$WARP_SUCCESS" = true ] && [ -f warp-terminal.deb ]; then
        echo "üì¶ Installing Warp Terminal..."
        if dpkg -i warp-terminal.deb; then
            echo "‚úÖ Warp Terminal installed successfully"
        else
            echo "üîß Fixing dependencies..."
            apt-get install -f -y && dpkg -i warp-terminal.deb || handle_error "Warp Terminal installation"
        fi
        rm -f warp-terminal.deb
    else
        echo "‚ö†Ô∏è Skipping Warp Terminal installation due to download failure"
    fi
    
    # Create optimized directory structure
    echo "üìÅ Creating test environment..."
    sudo -u vagrant mkdir -p /home/vagrant/warp-testing/{logs,reports,results,screenshots}
    
    # Copy API file if available
    if [ -f /vagrant/warp_api.py ]; then
      cp /vagrant/warp_api.py /home/vagrant/warp-testing/
      chmod +x /home/vagrant/warp-testing/warp_api.py
      chown -R vagrant:vagrant /home/vagrant/warp-testing
    fi
    
    # Clean up package cache to save space
    apt-get clean
    apt-get autoremove -y >/dev/null 2>&1
    
    echo "‚è∞ Setup completed at: $(date)"
    echo "‚úÖ ULTRA-FAST VM setup complete!"
    echo "üéØ VM is ready for snapshot creation and testing"
    
  SHELL
  
  # Quick test environment setup
  config.vm.provision "test_setup", type: "shell", run: "never", inline: <<-SHELL
    echo "üß™ Setting up clean test environment..."
    cd /home/vagrant/warp-testing
    
    # Clean previous test data
    rm -rf logs/* reports/* results/* screenshots/* 2>/dev/null || true
    
    # Sync latest API file
    if [ -f /vagrant/warp_api.py ]; then
      cp /vagrant/warp_api.py ./
      chmod +x warp_api.py
      chown vagrant:vagrant warp_api.py
    fi
    
    echo "‚úÖ Test environment ready for execution"
  SHELL
  
  # Fast cleanup
  config.vm.provision "test_cleanup", type: "shell", run: "never", inline: <<-SHELL
    echo "üßπ Fast cleanup..."
    
    # Kill any running processes
    pkill -f warp 2>/dev/null || true
    pkill -f xtrlock 2>/dev/null || true
    
    # Archive results
    cd /home/vagrant/warp-testing
    timestamp=$(date +%Y%m%d_%H%M%S)
    
    if ls logs/*.log >/dev/null 2>&1 || ls reports/* >/dev/null 2>&1; then
      tar -czf "/vagrant/test_results_${timestamp}.tar.gz" \
        logs/ reports/ results/ screenshots/ 2>/dev/null || true
      echo "üì¶ Results archived: test_results_${timestamp}.tar.gz"
    fi
    
    # Clean directories
    find logs reports results screenshots -type f -delete 2>/dev/null || true
    
    echo "‚úÖ Fast cleanup complete"
  SHELL
end